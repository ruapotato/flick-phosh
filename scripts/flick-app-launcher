#!/bin/bash
# Flick App Launcher for Phosh
# Properly launches QML apps with correct environment

APP_ID="$1"
APP_DIR="$2"

if [ -z "$APP_ID" ] || [ -z "$APP_DIR" ]; then
    echo "Usage: flick-app-launcher <app_id> <app_dir>"
    exit 1
fi

# State and logging
STATE_DIR="$HOME/.local/state/flick"
LOG_FILE="${STATE_DIR}/${APP_ID}.log"
mkdir -p "$STATE_DIR"

echo "=== $APP_ID started at $(date) ===" >> "$LOG_FILE"

# Set Wayland/Qt environment for phosh
export QT_QPA_PLATFORM=wayland
export QT_WAYLAND_DISABLE_WINDOWDECORATION=1

# Scale factor for phosh (adjust for proper UI size)
# Phosh typically runs at scale 2, Flick apps were designed for different scaling
export QT_SCALE_FACTOR=0.6
export QT_AUTO_SCREEN_SCALE_FACTOR=0

# Find the QML entry point
QML_FILE=""
if [ -f "$APP_DIR/app/main.qml" ]; then
    QML_FILE="$APP_DIR/app/main.qml"
elif [ -f "$APP_DIR/main.qml" ]; then
    QML_FILE="$APP_DIR/main.qml"
fi

if [ -z "$QML_FILE" ]; then
    echo "Error: No main.qml found in $APP_DIR" >> "$LOG_FILE"
    exit 1
fi

# Launch with qmlscene
exec /usr/lib/qt5/bin/qmlscene "$QML_FILE" 2>> "$LOG_FILE"
